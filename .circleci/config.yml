version: 2
jobs:
  build:
    ## Use preconfigured circleci image that has JDK 11 by default See https://discuss.circleci.com/t/early-preview-new-ubuntu-20-04-linux-machine-executor-image/37281
    ## has JDK 11, docker and maven
    machine:
      image: ubuntu-2004:202008-01
    ## Uses a "medium" sized machine (this is the default) - maybe increase this to "large" if you pay for CircleCI
    resource_class: medium
    working_directory: ~/repo
    environment:
      MAVEN_OPTS: -Xmx6400m
    steps:
      ## Checkout the source code
      - checkout

      ## Restore any files that may have been cached from previous jobs
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-

      ## Build the project
      ## This will cache the multi module jars in the local m2 repo and build the docker images
      ## Note. we can't just run mvn dependency:go-offline as the jars in the sub modules won't have been built yet
      - run:
          name: Build
          command: mvn clean install -DskipTests

      ## cache the dependencies
      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}
      - run:
          name: Test
          command: mvn test

      ## Push docker image if master build
      - run:
          name: Docker_Push
          command: |
                    if [ "${CIRCLE_BRANCH}" == "master" ]; then
                       echo "$DOCKER_PASS" | docker login --username $DOCKER_USER --password-stdin
                       docker push iainporter/sms-service:1.0.5
                    fi
